# Pipeline 语法

* `.gitlab-ci.yml`

`````yaml
before_script:
  - echo "before_script!!"

variables:
  DOMAIN: example.com

stages:
  - build
  - test
  - codescan
  - deploy

build:
  before_script:
    - echo "before_script in job"
  stage: build
  script:
    - echo "mvn clean"
    - echo "mvn install"
    - echo "$DOMAIN"
  after_script:
    - echo "after script in buildjob"

unittest:
  stage: test
  script:
    - echo "run test"
    
unittest2:
  stage: test
  script:
    - echo "run test2"

deploy:
  stage: deploy
  script:
    - echo "hello deploy"
    - sleep 2;

codescan:
  stage: codescan
  script:
    - echo "codescan"
    - sleep 5;

after_script:
  - echo "after_script"
  - ech
`````

##job

使用名为.gitlab-ci.yml的文件配置CI/CD管道（定义的流水线），在文件中可以有多个job，每个作业具有唯一的名称，每个job单独执行。定义了在相关条件下执行的操作，每个job至少包含一个script。

````
job1:
	script: "xxxx"
job2:
	script: "xxxx"
````

## script

## before_script

作业执行之前要做的操作，单个stage中不指定就会执行默认的全局，before_script和script在同一个进程中执行

## after_script

作业执行之后要做的操作，单个stage中不指定就会执行默认的全局

## stages 

指定stage，及执行的顺序

## stage

阶段,可以并行执行多个

并行执行时可能遇到一个执行一个暂停，需要修改runner服务的

`vim /etc/gitlab-runner/comfig.toml`

```
concurrent =10
```

## variables

指定全局的变量

## .pre

stage为.pre放到管道的第一个去运行

## .post

stage为.post 放到管道最后去执行

## tags

用于从runner中选择特定的runner执行，在runner注册期间指定。将不同job在不同runner上执行

## allow_failure

允许该作业失败，会以黄色展示，但被认为是通过的

````
allow_failure: true
````

## when

* `on_sucesss` 前面阶段中所有作业都成功时才执行作业，默认值
* `on_failure` 当前面阶段出现失败时执行
* `always` 总是执行作业
* `manual`手动执行作业，需要自己点下
* `delayed` 延迟执行作业

`````
deploy:
  stage: deploy
  script:
    - echo "hello deploy"
    - sleep 2;
  when: manual

codescan:
  stage: codescan
  script:
    - echo "codescan"
    - sleep 5;
  when: delayed
  start_in: '30'
`````

## retry

重试次数

````
retry: 2
````

重试可精准控制

* always：在发生任何故障时重试（默认）
* unknown_failure：当失败原因未知时
* ​

````
retry:
	max: 1
	when:
		 - script_failure
````

## timeout





## parallel





