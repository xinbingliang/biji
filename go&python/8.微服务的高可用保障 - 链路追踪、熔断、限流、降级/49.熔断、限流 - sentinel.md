# 熔断、限流 - sentinel

## 服务雪崩

![](../images/服务雪崩原因.png)

![](../images/雪崩应对策略.jpg)

熔断：

1. 请求都很慢-很高比例慢
2. 出现大比例请求错误
3. 单位时间内错误数量多

当A出现以上情况，那么A向B请求的服务，主动断开，一段时间后重新发送

## Sentinel

[Sentinel](https://github.com/alibaba/sentinel-golang)

[文档](https://sentinelguard.io/zh-cn/docs/introduction.html) 

[配置参数的说明](https://sentinelguard.io/zh-cn/docs/golang/flow-control.html)

- `Resource`：资源名，即规则的作用目标。
- `TokenCalculateStrategy`: 当前流量控制器的Token计算策略。Direct表示直接使用字段 Threshold 作为阈值；WarmUp表示使用预热方式计算Token的阈值。
- `ControlBehavior`: 表示流量控制器的控制策略；Reject表示超过阈值直接拒绝，Throttling表示匀速排队。
- `Threshold`: 表示流控阈值；如果字段 StatIntervalInMs 是1000(也就是1秒)，那么Threshold就表示QPS，流量控制器也就会依据资源的QPS来做流控。
- `RelationStrategy`: 调用关系限流策略，CurrentResource表示使用当前规则的resource做流控；AssociatedResource表示使用关联的resource做流控，关联的resource在字段 `RefResource` 定义；
- `RefResource`: 关联的resource；
- `WarmUpPeriodSec`: 预热的时间长度，该字段仅仅对 `WarmUp` 的TokenCalculateStrategy生效；
- `WarmUpColdFactor`: 预热的因子，默认是3，该值的设置会影响预热的速度，该字段仅仅对 `WarmUp` 的TokenCalculateStrategy生效；
- `MaxQueueingTimeMs`: 匀速排队的最大等待时间，该字段仅仅对 `Throttling` ControlBehavior生效；
- `StatIntervalInMs`: 规则对应的流量控制器的独立统计结构的统计周期。如果StatIntervalInMs是1000，也就是统计QPS。

## 基于QPS的限流

```go
package main

import (
	"fmt"
	sentinel "github.com/alibaba/sentinel-golang/api"
	"github.com/alibaba/sentinel-golang/core/base"
	"github.com/alibaba/sentinel-golang/core/flow"
	"log"
)

func main() {
	//先初始化sentinel
	err := sentinel.InitDefault()
	if err != nil {
		log.Fatalf("初始化sentinel异常：%v", err)
	}

	//配置限流规则
	_, err = flow.LoadRules([]*flow.Rule{
		{
			Resource:               "some-test",
			TokenCalculateStrategy: flow.Direct, // 统计的方式
			Threshold:              10,          // QPS
			StatIntervalInMs:       1000,        // 以一秒作为统计周期
			ControlBehavior:        flow.Reject, //流量控制的行为 拒绝，或匀速排队
		},
		{
			Resource:               "some-test2",
			TokenCalculateStrategy: flow.Direct, // 统计的方式
			Threshold:              10,          // QPS
			StatIntervalInMs:       1000,        // 以一秒作为统计周期
			ControlBehavior:        flow.Reject, //流量控制的行为 拒绝，或匀速排队
		},
	})

	if err != nil {
		log.Fatalf("加载规则失败：%v", err)
	}

	for i := 0; i <= 12; i++ {
		e, b := sentinel.Entry("some-test", sentinel.WithTrafficType(base.Inbound)) // 进行流入控制
		if b != nil {
			fmt.Printf("发生限流，检查不通过%d\n", i)
		}else {
			fmt.Printf("检查通过%d\n", i)
			e.Exit() //没问题一定要退出
		}
	}
}
```

## 预热

WarmUp方式，即预热/冷启动方式。当系统长期处于低水位的情况下，当流量突然增加时，直接把系统拉升到高水位可能瞬间把系统压垮。通过"冷启动"，让通过的流量缓慢增加，在一定时间内逐渐增加到阈值上限，给冷系统一个预热的时间，避免冷系统被压垮。













