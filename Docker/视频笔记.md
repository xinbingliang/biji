# Docker视频笔记

## Docker 构成

* Docker Client： Docker的客户端
* Docker Server：Docker daemon的主要组成部分，接收用户通过Docker Client 发送请求，并按照相应的路由规则实现路由分发
* Docker Registry：Registry 是Docker镜像的中央存储库

**Docker镜像：Docker镜像运行后变成容器**

## Dockerfile

```shell
FROM       centos:centos7.1.1503 # 表示基础镜像，父镜像，基于什么创建
MAINTAINER Carson,C.J.Zeong <zcy@nicescale.com> #作者信息

ENV TZ "Asia/Shanghai" # 时区的环境变量
ENV TERM xterm # 

ADD aliyun-mirror.repo /etc/yum.repos.d/CentOS-Base.repo # 复制文件，但和copy的区别是多远程复制功能，可以将压缩包直接解压缩
ADD aliyun-epel.repo /etc/yum.repos.d/epel.repo

# 执行命令
RUN yum install -y curl wget tar bzip2 unzip vim-enhanced passwd sudo yum-utils hostname net-tools rsync man && \
    yum install -y gcc gcc-c++ git make automake cmake patch logrotate python-devel libpng-devel libjpeg-devel && \
    yum install -y --enablerepo=epel pwgen python-pip && \
    yum clean all

RUN pip install supervisor # 运行进程管理工具
ADD supervisord.conf /etc/supervisord.conf # 添加主配置文件

RUN mkdir -p /etc/supervisor.conf.d && \ # 创建文件
    mkdir -p /var/log/supervisor

EXPOSE 22 # 对外暴露的端口

ENTRYPOINT ["/usr/bin/supervisord", "-n", "-c", "/etc/supervisord.conf"] # 只有最后一条运行，开启时执行命令
```

* `docker build -t registry_url/namespace/csphere/centos:7.1 .` 构建镜像

* `docker images` 查看生成的镜像

* `docker run `  生成容器

  * `-it` 交互模式
  * `-d` 在后台启动
  * `-p`  指定端口连接docker服务
  * `-P 22` 宿主机随机分配端口连接docker服务 
  * `--name base` 将容器重命名为base 

  ````shell
  docker run -d -p 55555:22 --name base csphere/centos:7.1
  ````

* `docker ps -a`  查看说有的容器

**基础镜像->中间件镜像->应用镜像**

```
ONBUILD ADD . /app
ONBUILD RUN chown -R nginx:nginx /app
```

* `docker build -t csphere/php-fpm:5.4 .` 
* `docker run -d -p 8080:80 --name website csphere/php-fpm:5.4`
* `http://192.168.2.79:8080/info.php` 尝试访问
* `docker exec -it website /bin/bash` 进入容器
* `supervisorctl` 进程管理命令

 ````shell
VOLUME ["/var/lib/mysql"] # 将mysql文件保存到宿主机上，保证数据不删除

ENTRYPOINT ["/scripts/start"] # 以脚本文件形式启动
 ````

* bash 编程中使用`set -e` 当出现错误时
* `docker build -t csphere/mysql:5.5 .` 构建mysql镜像
* `docker run -d -p 33333:3306 --name dbserver csphere/mysql:5.5` 启动
* `docker exec -it dbserver /bin/bash` 进入dbserver
* `docker rm -f dbserver` rm只能停止后删除，-f强制操作
* `docker run -d -p 3306:3306 -v /var/test/docker/vfs/dir/mydata:/var/lib/mysql csphere/mysql:5.5`  将数据放在宿主目录上
* `docker stop xxx` 停止一个容器
* `docker ps ` 显示up状态下的容器
* `docker rm xxx` 删除一个容器
* `docker run  -d -p 3306:3306 --name newdb -v /var/test/docker/vfs/dir/mydata:/var/lib/mysql csphere/mysql:5.5` 启动docker 
* `.dockerignore` 表示拷贝时忽略的文件
* `docker run -d -p  80:80 --name wordpress -e WORDPRESS_DB_HOST=192.168.2.79 -e `
* `docker build -t scphere/wordpress:4.2 /home/xin/docker/docker-training/wordpress/` 构建镜像
* `WORDPRESS_DB_USER=admin -e WORDPRESS_DB_PASSWORD=csphere2015 scphere/wordpress:4.2` 启动wordpress镜像
* ENTRYPOINT
  * `ENTRYPOINT ["executable", "param1", "param2"]` 进程pid为1
  * `ENTRYPOINT command param1 param2` 使用shell的pid
* CMD
  * `CMD ["executable", "param1", "param2"] ` 运行一个可执行的文件并提供参数
  * `CMD ["param1", "param2" ]` 为ENTRYPOINT指定参数
  * `CMD command param1 param1 ` 以'/bin/sh -c' 的方法执行的命令，shellpid


## Dockerfile

````shell
FROM csphere/centos:7.1

CMD ["/bin/echo", "This is test cmd"]
````

* `docker build -t csphere/cmd:0.1 .` 构建镜像
* `docker run -it --rm csphere/cmd:0.1` 执行完成后就直接删除容器
* `docker run -it  csphere/cmd:0.1 /bin/bash` 指定命令后会替换Dockerfile中的指令

```shell
FROM csphere/centos:7.1

ENTRYPOINT ["/bin/echo", "This is test entrypoint"]
```

* `docker run -it  csphere/cmd:0.1 /bin/bash` 指定命令后并不能替换Dockerfile中的指令
* `docker run -it --entrypoint= csphere/cmd:0.1` 覆盖 `Dockerfile`中的`ENTRYPOINT`
* `docker rmi  xxx` 直接删除镜像














