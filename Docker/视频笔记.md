# Docker视频笔记

## Docker 构成

* Docker Client： Docker的客户端
* Docker Server：Docker daemon的主要组成部分，接收用户通过Docker Client 发送请求，并按照相应的路由规则实现路由分发
* Docker Registry：Registry 是Docker镜像的中央存储库

**Docker镜像：Docker镜像运行后变成容器**

## Dockerfile

```shell
FROM       centos:centos7.1.1503 # 表示基础镜像，父镜像，基于什么创建
MAINTAINER Carson,C.J.Zeong <zcy@nicescale.com> #作者信息

ENV TZ "Asia/Shanghai" # 时区的环境变量
ENV TERM xterm # 

ADD aliyun-mirror.repo /etc/yum.repos.d/CentOS-Base.repo # 复制文件，但和copy的区别是多远程复制功能，可以将压缩包直接解压缩
ADD aliyun-epel.repo /etc/yum.repos.d/epel.repo

# 执行命令
RUN yum install -y curl wget tar bzip2 unzip vim-enhanced passwd sudo yum-utils hostname net-tools rsync man && \
    yum install -y gcc gcc-c++ git make automake cmake patch logrotate python-devel libpng-devel libjpeg-devel && \
    yum install -y --enablerepo=epel pwgen python-pip && \
    yum clean all

RUN pip install supervisor # 运行进程管理工具
ADD supervisord.conf /etc/supervisord.conf # 添加主配置文件

RUN mkdir -p /etc/supervisor.conf.d && \ # 创建文件
    mkdir -p /var/log/supervisor

EXPOSE 22 # 对外暴露的端口

ENTRYPOINT ["/usr/bin/supervisord", "-n", "-c", "/etc/supervisord.conf"] # 只有最后一条运行，开启时执行命令
```

* `docker build -t registry_url/namespace/csphere/centos:7.1 .` 构建镜像

* `docker images` 查看生成的镜像

* `docker run `  生成容器

  * `-it` 交互模式
  * `-d` 在后台启动
  * `-p`  指定端口连接docker服务
  * `-P 22` 宿主机随机分配端口连接docker服务 
  * `--name base` 将容器重命名为base 

  ````shell
  docker run -d -p 55555:22 --name base csphere/centos:7.1
  ````

* `docker ps -a`  查看说有的容器

**基础镜像->中间件镜像->应用镜像**

```
ONBUILD ADD . /app
ONBUILD RUN chown -R nginx:nginx /app
```

* `docker build -t csphere/php-fpm:5.4 .` 
* `docker run -d -p 8080:80 --name website csphere/php-fpm:5.4`
* `http://192.168.2.79:8080/info.php` 尝试访问
* `docker exec -it website /bin/bash` 进入容器
* `supervisorctl` 进程管理命令

 ````shell
VOLUME ["/var/lib/mysql"] # 将mysql文件保存到宿主机上，保证数据不删除

ENTRYPOINT ["/scripts/start"] # 以脚本文件形式启动
 ````

* bash 编程中使用`set -e` 当出现错误时
* `docker build -t csphere/mysql:5.5 .` 构建mysql镜像
* `docker run -d -p 33333:3306 --name dbserver csphere/mysql:5.5` 启动
* `docker exec -it dbserver /bin/bash` 进入dbserver
* `docker rm -f dbserver` rm只能停止后删除，-f强制操作
* `docker run -d -p 3306:3306 -v /var/test/docker/vfs/dir/mydata:/var/lib/mysql csphere/mysql:5.5`  将数据放在宿主目录上
* ​

















