# 容器编排Docker Swarm

## 容器编排Swarm介绍

![](../swarm.png)

![](../service_replicas.png)

## 创建一个三节点的swarm集群

* `docker swarm init --advertise-addr=192.168.232.145` 在`node1`(Manager)上运行，成为Manager，会告诉其他机器如何运行命令
* `docker swarm join --token SWMTKN-1-11xo5ouv5wxvje7tkwmnqatykjkjoxllkxv0jxq41r4aya4jug-cb5juetk13ep66rohk5pnaabj 192.168.232.145:2377` 在work1节点上运行，加入进来
* `docker node ls` 显示swarm中的节点

## Service的创建维护和水平扩展

* `docker service create`
* `docker service create --name demo busybox sh -c "while true; do sleep 3600;done"` 
* `docker service ps demo`  查看容器运行情况
* `docker service ls` 列出服务
* `docker service scale demo=5` 水平扩展
* `docker service ls` 列出服务
* `docker rm -f 838ba377c564 `  删除其中一个
* `docker service ps demo`  查看容器运行情况
* `docker service rm demo` 删除服务

## 在swarm集群里通过service部署wordpress

**创建overlay**

* `docker network create -d overlay demo` 创建一个叫demo的overlay网络
* ` docker network ls` 其他机器上看不到创建的网络

**创建mysql service**

* `docker service create --name mysql --env MYSQL_ROOT_PASSWORD=root --env MYSQL_DATABASE=wordpress --network demo --mount type=volume,source=mysql-data,destination=/var/lib/mysql mysql` 
* `docker service ls` 
* `docker service ps ls`

**创建wordpress serbice**

* `docker service create --name wordpress -p 8088:80 --network demo --env WORDPRESS_DB_PASSWORD=root --env WORDPRESS_DB_HOST=mysql wordpress` 创建另外一个service
* 使用任意节点的地址都能访问
* 当服务被分配时，网络也被分配

## 集群服务间通信之Routing Mesh

- `docker network create -d overlay demo` 创建一个网络
- `docker service create --name whoami -p 8000:8000 --network demo -d jwilder/whoami`
- `docker service ps whoami`
- `docker service create --name client -d --network demo busybox sh -c "while true; do sleep 3600;done"`
- `docker service ls`
- `docker exec -it f9f8 sh` 进入到`busybox`容器中
- `ping whoami` 去`busybox`中ping另外一个service
- `docker service scale whoami=2`  扩展
- `docker service ls`
- `ping whoami` 去`busybox`中ping另外一个service
- 实际上使用的虚拟IP
- `nslookup www.baidu.com` 用于查询DNS

![](../routingmesh.png)

>* Internal ：Container和Container之间的访问通过overlay网络（通过VIP虚拟IP）
>* Ingress：如果服务有绑定接口，则此服务可以通过任意Swarm节点的相应接口访问

## Routing Mesh之Ingress负载均衡

* 外部访问的负载均衡
* 服务端口被暴露到各个swarm节点
* 内部通过IPVS进行负载均衡

![](../ingress.png)

## Docker Stack部署Wordpress



## 作业解答之部署投票应用



## Docker Secret管理和使用



## Docker Secret在Stack中的使用



## Service更新





