# restful api介绍

## json返回

```python
from django.contrib import admin
from django.urls import path,include
import xadmin

# 用于配置媒体资源访问
from rest.settings import MEDIA_ROOT
from django.views.static import serve

from goods.views_base import GoodsListView

urlpatterns = [
    path('super/', xadmin.site.urls), # 后台管理
    path('admin/', admin.site.urls),
    path('tinymce/', include('tinymce.urls')),
    path('media/', serve, {"document_root": MEDIA_ROOT}),

    # 商品列表页面
    path('goods/', GoodsListView.as_view(), name="goods-list"),
]
```

````json
from django.views.generic.base import View

from goods.models import Goods

class GoodsListView(View):
    def get(self, request):
        """
        工作量大，没办法对时间进行序列化
        :param request:
        :return:
        """
        json_list = []
        goods = Goods.objects.all()[:10]
        # for good in goods:
        #     json_dict = {}
        #     json_dict["name"] = good.name
        #     json_dict["category"] = good.category.name
        #     json_dict["market_price"] = good.market_price
        #     json_list.append(json_dict)

        # from django.forms.models import model_to_dict # 用来将查询对象转dict
        # for good in goods:
        #     json_dict = model_to_dict(good)
        #     json_list.append(json_dict)

        from django.core import serializers # 用于对字段进行序列化
        import json

        json_data = serializers.serialize("json", goods)
        json_data = json.loads(json_data)

        from django.http import HttpResponse,JsonResponse
        # return HttpResponse(json.dumps(json_data), content_type="application/json")
        # return HttpResponse(json_data, content_type="application/json")
        return JsonResponse(json_data, safe=False)
````

## drf安装和引入

### 依赖安装

- djangorestframework
- coreapi
- Markdown
- django-filter
- django-crispy-forms
- django-guardian

### 配置

```python
INSTALLED_APPS = [
   	...
    'rest_framework',
]
```

### 引入文档

```python
# rest/urls.py
from rest_framework.documentation import include_docs_urls

urlpatterns = [
   ...
    path('api-auth/', include('rest_framework.urls')),
  
    path("docs/$", include_docs_urls(title="生鲜测试")) # 用于后期生成文档
]
```

### 简单例子

````python
# urls.py
from goods.views import GoodsListView

urlpatterns = [
	path('goods/', GoodsListView.as_view(), name="goods-list"),
]
````

````python
# views.py
from .serializer import GoodsSerializer
from rest_framework.views import APIView
from rest_framework.response import Response

from .models import Goods

class GoodsListView(APIView):
    def get(self, request, format=None):
        goods = Goods.objects.all()[:10]
        goods_serializers = GoodsSerializer(goods, many=True) # 得到结果集为列表加many
        return Response(goods_serializers.data)
````

````python
# 新建serializer.py
from rest_framework import serializers

class GoodsSerializer(serializers.Serializer):
    # 可以自己指明字段
    name = serializers.CharField(max_length=100, required=True) # required是否必须
    click_num = serializers.IntegerField(default=0, )

````

* 使用浏览器访问查看

## 字段的保存

````python
from rest_framework import serializers
from .models import Goods

class GoodsSerializer(serializers.Serializer):
    # 可以自己指明字段
    name = serializers.CharField(max_length=100, required=True) # required是否必须
    click_num = serializers.IntegerField(default=0, )
    goods_front_images = serializers.ImageField()

    def create(self, validated_data): # validated_data将以上字段放入其中
        return Goods.objects.create(**validated_data)
````

````python
from .serializer import GoodsSerializer
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status

from .models import Goods

class GoodsListView(APIView):
    def get(self, request, format=None):
        goods = Goods.objects.all()[:10]
        goods_serializers = GoodsSerializer(goods, many=True) # 得到结果集为列表加many
        return Response(goods_serializers.data)

    def post(self, request):
        serializer = GoodsSerializer(data=request.data)
        if serializer.is_valid():
            serializer.save()
            return Response(serializer.data, status=status.HTTP_201_CREATED)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
````

## ModelSerializer

```python
from rest_framework import serializers
from .models import Goods

class GoodsSerializer(serializers.ModelSerializer):
    class Meta:
        model = Goods
        fields = ('id', 'name', 'click_num', 'market_price', 'add_time')
        # fields = "__all__"
```

## 关联相关

````python
from rest_framework import serializers
from .models import Goods,GoodsCategory

class GoodsCategorySerializer(serializers.ModelSerializer):
    class Meta:
        model = GoodsCategory
        fields = "__all__"

class GoodsSerializer(serializers.ModelSerializer):
    # 自定义字段
    category = GoodsCategorySerializer()

    class Meta:
        model = Goods
        fields = "__all__"
````











