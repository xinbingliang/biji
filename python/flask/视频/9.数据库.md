# 数据库

SQLAlchemy是一个关系型数据库框架，它提供了高层的ORM和底层的原生数据库的操作。 

## 安装

**安装服务端**

```
sudo apt-get install mysql-server
```

**安装客户端**

```
sudo apt-get install mysql-client
sudo apt-get install libmysqlclient-dev
```

**安装一个flask-sqlalchemy的扩展**

```
pip install flask-sqlalchemy
```

要连接mysql数据库，仍需要安装flask-mysqldb

```
pip install flask-mysqldb
```

## Flask-SQLAlchemy管理数据库

* `app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql://root:mysql@127.0.0.1:3306/test3'` 数据库连接设置
* `app.config["SQLALCHEMY_COMMIT_ON_TEARDOWN"] = True` 每次请求结束会自动提交对数据库的改动
* `app.config["SQLALCHEMY_TRACK_MODIFICATIONS"] = True` 每次模型层的修改都自动同步
* `app.config["SQLALCHEMY_ECHO"] = True` 查询时显示原始SQL语句

## 常用的SQLAlchemy字段类型

| 类型名       | python中类型      | 说明                                                |
| ------------ | ----------------- | --------------------------------------------------- |
| Integer      | int               | 普通整数，一般是32位                                |
| SmallInteger | int               | 取值范围小的整数，一般是16位                        |
| BigInteger   | int或long         | 不限制精度的整数                                    |
| Float        | float             | 浮点数                                              |
| Numeric      | decimal.Decimal   | 普通整数，一般是32位                                |
| String       | str               | 变长字符串                                          |
| Text         | str               | 变长字符串，对较长或不限长度的字符串做了优化        |
| Unicode      | unicode           | 变长Unicode字符串                                   |
| UnicodeText  | unicode           | 变长Unicode字符串，对较长或不限长度的字符串做了优化 |
| Boolean      | bool              | 布尔值                                              |
| Date         | datetime.date     | 时间                                                |
| Time         | datetime.datetime | 日期和时间                                          |
| LargeBinary  | str               | 二进制文件                                          |

## 常用的SQLAlchemy列选项

| 选项名      | 说明                                              |
| ----------- | ------------------------------------------------- |
| primary_key | 如果为True，代表表的主键                          |
| unique      | 如果为True，代表这列不允许出现重复的值            |
| index       | 如果为True，为这列创建索引，提高查询效率          |
| nullable    | 如果为True，允许有空值，如果为False，不允许有空值 |
| default     | 为这列定义默认值                                  |

## 常用的SQLAlchemy关系选项

| 选项名         | 说明                                                         |
| -------------- | ------------------------------------------------------------ |
| backref        | 在关系的另一模型中添加反向引用                               |
| primary join   | 明确指定两个模型之间使用的联结条件                           |
| uselist        | 如果为False，不使用列表，而使用标量值                        |
| order_by       | 指定关系中记录的排序方式                                     |
| secondary      | 指定多对多中记录的排序方式                                   |
| secondary join | 在SQLAlchemy中无法自行决定时，指定多对多关系中的二级联结条件 |

## 构建模型

````python
from flask import Flask
from flask_sqlalchemy import SQLAlchemy

app = Flask(__name__)

# app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql://root:root@127.0.0.1:3306/flask_test'
# app.config["SQLALCHEMY_TRACK_MODIFICATIONS"] = True
# app.config["SQLALCHEMY_ECHO"] = True

class Config(object):
    SQLALCHEMY_DATABASE_URI = 'mysql://root:root@127.0.0.1:3306/flask_test'
    SQLALCHEMY_TRACK_MODIFICATIONS = True
    SQLALCHEMY_ECHO = True


app.config.from_object(Config)

# 创建SQLAlchemy工具对象
db = SQLAlchemy(app)


class Roles():
    """用户角色表"""
    __tablename__ = 'tbl_roles'  # 指明数据库的表名称

    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(32), unique=True)
    users = db.relationship("User", backref="role")  # 不真实存在，用于查询方便,backref反推给User添加一个虚拟属性role


class User(db.Model):
    """用户表"""
    __tablename__ = 'tbl_users'  # 指明数据库的表名称

    id = db.Column(db.Integer, primary_key=True) # 整形主键,默认会自增
    name = db.Column(db.String(64), unique=True)
    email = db.Column(db.String(128), unique=True)
    password = db.Column(db.String(128))
    role_id = db.Column(db.Integer, db.ForeignKey("tbl_roles.id"))  # 外键，这里使用表名

@app.route("/")
def index():
    return "index page"

if __name__ == '__main__':
    app.run(debug=True)
````

## 迁移

### 最原始方式

````python
from flask import Flask
from flask_sqlalchemy import SQLAlchemy

app = Flask(__name__)

# app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql://root:root@127.0.0.1:3306/flask_test'
# app.config["SQLALCHEMY_TRACK_MODIFICATIONS"] = True
# app.config["SQLALCHEMY_ECHO"] = True

class Config(object):
    SQLALCHEMY_DATABASE_URI = 'mysql://root:root@127.0.0.1:3306/flask_test'
    SQLALCHEMY_TRACK_MODIFICATIONS = True
    SQLALCHEMY_ECHO = True


app.config.from_object(Config)

# 创建SQLAlchemy工具对象
db = SQLAlchemy(app)


class Role():
    """用户角色表"""
    __tablename__ = 'tbl_role'  # 指明数据库的表名称

    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(32), unique=True)
    users = db.relationship("User", backref="role")  # 不真实存在，用于查询方便,backref反推给User添加一个虚拟属性role


class User(db.Model):
    """用户表"""
    __tablename__ = 'tbl_users'  # 指明数据库的表名称

    id = db.Column(db.Integer, primary_key=True) # 整形主键,默认会自增
    name = db.Column(db.String(64), unique=True)
    email = db.Column(db.String(128), unique=True)
    password = db.Column(db.String(128))
    role_id = db.Column(db.Integer, db.ForeignKey("tbl_role.id"))  # 外键，这里使用表名


# @app.route("/")
# def index():
#     return "index page"


if __name__ == '__main__':
    # app.run(debug=True)
    # 第一次时候，清除数据库中的所有数据
    db.drop_all()
    # 创建所有的表
    db.create_all()
````

* `python demo.py` 运行即可

### 使用迁移的方式

* `pip install flask-migrate`
* `python demo.py db init`

